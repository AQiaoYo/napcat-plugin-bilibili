<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bç«™è§†é¢‘è§£æ Â· æ§åˆ¶å°</title>
    <script src="static/plugin-info.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bili: {
                            pink: '#FB7299',
                            blue: '#00A1D6',
                            dark: '#18191C',
                            gray: '#F4F4F4',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; }
        html, body { height: 100%; margin: 0; overflow: hidden; background: #f0f2f5; color: #1f2937; font-size: 16px; }
        
        .app-layout {
            display: grid;
            grid-template-rows: auto 1fr;
            height: 100vh;
        }

        .main-content {
            display: grid;
            grid-template-columns: 25% 1fr;
            gap: 16px;
            padding: 16px;
            min-height: 0;
        }

        /* ç»Ÿä¸€å¡ç‰‡ */
        .glass-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.05);
            border: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
        }

        /* ä¾§è¾¹æ å‚ç›´å¸ƒå±€ */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
            overflow-y: auto;
            padding-right: 4px;
        }

        /* æ»šåŠ¨æ¡ç¾åŒ– */
        .sidebar::-webkit-scrollbar, .scroll-area::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb, .scroll-area::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 10px; }

        .account-mini { padding: 16px; }

        /* é¡¶éƒ¨çŠ¶æ€æ¡ */
        .top-stat-item {
            padding: 0 24px;
            border-right: 1px solid #e5e7eb;
        }
        .top-stat-item:last-child { border-right: none; }

        /* ç¾¤åˆ—è¡¨å®¹å™¨ */
        .scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        /* å¼€å…³ç¾åŒ– */
        .toggle-switch { position: relative; width: 48px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background-color: #d1d5db;
            transition: 0.3s;
            border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider { background-color: #00A1D6; }
        input:checked + .toggle-slider:before { transform: translateX(24px); }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 100; }
        .toast { padding: 12px 24px; border-radius: 8px; color: white; margin-bottom: 8px; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        .group-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #f3f4f6;
            transition: all 0.2s;
            background: #fff;
        }
        .group-item:hover { border-color: #00A1D6; box-shadow: 0 2px 8px rgba(0,161,214,0.1); }
    </style>
</head>

<body>
    <div id="toast-container" class="toast-container"></div>

    <div class="app-layout">
        <!-- é¡¶éƒ¨é€šæ  -->
        <header class="bg-white border-b border-gray-200 px-8 py-4 flex items-center justify-between shadow-sm z-10">
            <div class="flex items-center gap-4">
                <svg class="w-8 h-8" viewBox="0 0 1071 1024" xmlns="http://www.w3.org/2000/svg">
                    <path d="M887.365188 952.783894H184.455499C82.758914 952.783894 0 876.72402 0 783.272408V336.111466c0-93.477378 82.758914-169.537251 184.455499-169.537252h704.043373c51.969094 0 101.67082 20.225949 136.377002 55.498973A159.256801 159.256801 0 0 1 1071.846453 336.420652V783.272408c0 93.451613-82.758914 169.511486-184.481265 169.511486zM184.455499 251.600495c-54.829069 0-99.429218 37.901109-99.429218 84.510971V783.272408c0 46.609861 44.600149 84.51097 99.429218 84.51097H887.365188c54.829069 0 99.429218-37.901109 99.429218-84.51097V335.415796a74.539706 74.539706 0 0 0-22.570613-53.72115c-18.808844-19.11803-46.377972-30.09415-75.750687-30.094151z" fill="#FB7299"/>
                    <path d="M397.794168 495.316736L219.651226 535.923226a36.355177 36.355177 0 0 1-15.175903-71.112889l178.142942-40.55496a35.8141 35.8141 0 0 1 43.131513 27.955611c4.302845 19.169562-8.786049 38.854434-27.95561 43.157279zM674.052285 495.316736c-19.169562-4.302845-32.258456-23.987717-27.955611-43.157279a35.8141 35.8141 0 0 1 43.131514-27.955611l178.142941 40.55496a36.355177 36.355177 0 0 1-15.175902 71.112889l-178.142942-40.554959zM268.811876 1023.999845a56.684187 56.684187 0 0 1-56.684187-56.813015v-42.590437a56.684187 56.684187 0 1 1 113.600264 0v42.590437a56.684187 56.684187 0 0 1-56.684187 56.813015zM803.034577 1023.999845a56.684187 56.684187 0 0 1-56.813015-56.813015v-42.590437a56.684187 56.684187 0 1 1 113.600264 0v42.590437a56.684187 56.684187 0 0 1-56.684187 56.813015z" fill="#FB7299"/>
                    <path d="M248.918821 42.946487m26.538343-29.671097l0 0q26.538343-29.671097 56.20944-3.132755l185.900469 166.272595q29.671097 26.538343 3.132754 56.20944l0 0q-26.538343 29.671097-56.20944 3.132755l-185.900468-166.272595q-29.671097-26.538343-3.132755-56.20944Z" fill="#FB7299"/>
                    <path d="M577.629382 262.330313m-26.538343-29.671098l0 0q-26.538343-29.671097 3.132755-56.20944l185.900468-166.272595q29.671097-26.538343 56.209441 3.132755l0 0q26.538343 29.671097-3.132755 56.20944l-185.900468 166.272595q-29.671097 26.538343-56.209441-3.132755Z" fill="#FB7299"/>
                    <path d="M595.621982 756.373184a39.447041 39.447041 0 0 1-30.738289-14.686357L533.346672 702.677799l-32.438814 38.467951a39.730462 39.730462 0 0 1-55.473207 5.153108l-44.316729-36.535535a23.188986 23.188986 0 1 1 29.501543-35.762569l39.163621 32.258455 33.495202-39.601634a39.6274 39.6274 0 0 1 61.038563 0.566842l32.722236 40.323069 45.424646-33.933215A23.188986 23.188986 0 1 1 669.904033 710.665117l-50.655051 37.798047a39.369745 39.369745 0 0 1-23.627 7.91002z" fill="#FB7299"/>
                </svg>
                <h1 class="text-xl font-bold text-gray-800 tracking-tight">Bç«™è§†é¢‘è§£æ Â· æ§åˆ¶ä¸­å¿ƒ</h1>
                <span id="status-badge" class="ml-2 px-3 py-1 rounded-full text-xs font-bold bg-green-100 text-green-600 border border-green-200">è¿è¡Œä¸­</span>
                <button class="ml-2 p-2 hover:bg-gray-100 rounded-full transition-colors group" title="åˆ·æ–°æ•°æ®" onclick="refreshAll()">
                    <svg class="w-5 h-5 text-gray-500 group-hover:text-bili-blue transition-colors" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                        <path d="M21 3v5h-5"/>
                    </svg>
                </button>
            </div>

            <div class="flex items-center h-10">
                <div class="top-stat-item flex flex-col items-center">
                    <span class="text-xs text-gray-400 mb-1">ä»Šæ—¥è§£æ</span>
                    <span id="stats-today" class="text-lg font-bold text-blue-600">0</span>
                </div>
                <div class="top-stat-item flex flex-col items-center">
                    <span class="text-xs text-gray-400 mb-1">ç´¯è®¡è§£æ</span>
                    <span id="stats-total" class="text-lg font-bold text-blue-600">0</span>
                </div>
                <div class="top-stat-item flex flex-col items-center">
                    <span class="text-xs text-gray-400 mb-1">æ´»è·ƒç¾¤èŠ</span>
                    <span id="enabled-groups" class="text-lg font-bold text-pink-500">0</span>
                </div>
                <div class="top-stat-item flex flex-col items-center border-none">
                    <span class="text-xs text-gray-400 mb-1">è¿è¡Œæ—¶é•¿</span>
                    <span id="uptime" class="text-lg font-bold text-gray-700 min-w-[5em] text-center" style="font-variant-numeric: tabular-nums;">--</span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <!-- å·¦ä¾§è¾¹æ  (25%) -->
            <aside class="sidebar">
                <!-- è´¦å·çŠ¶æ€ -->
                <div class="glass-card shadow-sm">
                    <div class="px-5 py-4 border-b border-gray-50 flex items-center gap-3 font-bold text-base text-gray-700 bg-gray-50/50 rounded-t-xl">
                        <span>ğŸ”</span> ç™»å½•ä¿¡æ¯
                    </div>
                    
                    <div id="login-loading" class="p-8 text-center text-sm text-gray-400">æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...</div>

                    <!-- æœªç™»å½• -->
                    <div id="login-section" class="hidden p-6 text-center">
                        <div id="qrcode-placeholder" class="mb-4">
                            <button class="w-full py-3 bg-blue-500 text-white rounded-xl text-sm font-bold hover:bg-blue-600 transition shadow-md shadow-blue-100" onclick="generateQrCode()">
                                ç«‹å³æ‰«ç ç™»å½•
                            </button>
                        </div>
                        <div id="qrcode-wrapper" class="hidden">
                            <img id="qrcode-img" class="w-40 h-40 mx-auto border-4 border-white shadow-sm rounded-xl mb-3" src="">
                            <div id="qrcode-status" class="text-xs text-gray-500 mb-3">è¯·ä½¿ç”¨ Bilibili App æ‰«ç </div>
                            <button class="text-sm text-blue-500 font-medium hover:underline" onclick="generateQrCode()">åˆ·æ–°äºŒç»´ç </button>
                        </div>
                    </div>

                    <!-- å·²ç™»å½• -->
                    <div id="logged-in-section" class="hidden account-mini">
                        <div class="flex items-center gap-4" style="margin-bottom: 1rem;">
                            <img id="user-avatar" class="w-14 h-14 rounded-full border-2 border-white ring-2 ring-blue-400 shadow-sm" src="">
                            <div class="min-w-0">
                                <div class="flex items-center gap-2">
                                    <span id="user-name" class="font-bold text-base text-gray-800 truncate">--</span>
                                    <span id="user-vip" class="text-[10px] bg-pink-500 text-white px-1.5 py-0.5 rounded font-bold hidden">VIP</span>
                                </div>
                                <div id="user-uid" class="text-xs text-gray-400 mt-1">UID: --</div>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between text-xs text-gray-400 mb-2 font-medium">
                                    <span class="text-orange-500 font-bold italic">LV<span id="user-level">0</span></span>
                                    <span><span id="user-exp-current">0</span> / <span id="user-exp-next">0</span></span>
                                </div>
                                <div class="h-2 bg-gray-100 rounded-full overflow-hidden shadow-inner">
                                    <div id="user-level-progress" class="h-full bg-gradient-to-r from-orange-400 to-yellow-300 transition-all duration-700" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-3 gap-2 border-t border-b border-gray-50 bg-gray-50/30 rounded-lg" style="padding-top: 0.5rem; padding-bottom: 0.5rem;">
                                <div class="text-center">
                                    <div class="text-[10px] text-gray-400 mb-1 font-medium">ç¡¬å¸</div>
                                    <div id="user-money" class="text-sm font-bold text-gray-700">--</div>
                                </div>
                                <div class="text-center border-l border-r border-gray-100">
                                    <div class="text-[10px] text-gray-400 mb-1 font-medium">ç²‰ä¸</div>
                                    <div id="user-follower" class="text-sm font-bold text-gray-700">--</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-[10px] text-gray-400 mb-1 font-medium">èŠ‚æ“</div>
                                    <div id="user-moral" class="text-sm font-bold text-gray-700">--</div>
                                </div>
                            </div>
                            
                            <button class="w-full py-2.5 text-xs text-red-500 font-bold hover:bg-red-50 rounded-xl transition border border-red-100 mt-2" onclick="logout()">é€€å‡ºç™»å½•</button>
                        </div>
                    </div>
                </div>

                <!-- æ’ä»¶è®¾ç½® -->
                <div class="glass-card shadow-sm">
                    <div class="px-5 py-4 border-b border-gray-50 flex items-center gap-3 font-bold text-base text-gray-700 bg-gray-50/50 rounded-t-xl">
                        <span>âš™ï¸</span> åŠŸèƒ½é…ç½®
                    </div>
                    <div class="p-5 space-y-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-bold text-gray-800">å…¨å±€è§£æå¼€å…³</div>
                                <div class="text-xs text-gray-400 mt-1">æ§åˆ¶æ‰€æœ‰ç¾¤çš„è‡ªåŠ¨åŒ–å¤„ç†</div>
                            </div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="global-toggle" onchange="toggleGlobal(this.checked)">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>

                        <div>
                            <div class="text-sm font-bold text-gray-800 mb-2">é»˜è®¤å‘é€æ¨¡å¼</div>
                            <select id="send-mode" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:border-blue-400 focus:bg-white transition" onchange="updateConfig()">
                                <option value="info-only">ä»…å‘é€è§†é¢‘æ¦‚è§ˆå¡ç‰‡</option>
                                <option value="with-video">å‘é€æ¦‚è§ˆå¡ç‰‡ + è§†é¢‘æºæ–‡ä»¶</option>
                            </select>
                        </div>

                        <div>
                            <div class="text-sm font-bold text-gray-800 mb-2">å•è§†é¢‘å¤§å°é˜ˆå€¼ (MB)</div>
                            <input type="number" id="max-video-size" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl text-sm outline-none focus:border-blue-400 focus:bg-white transition" min="1" max="1000" onchange="updateConfig()">
                            <p class="text-[10px] text-gray-400 mt-2">è¶…è¿‡æ­¤å¤§å°çš„è§†é¢‘å°†åªå‘é€ä¿¡æ¯å¡ç‰‡</p>
                        </div>
                    </div>
                </div>

            </aside>

            <!-- å³ä¾§ä¸»åŒºåŸŸ (75%) -->
            <section class="glass-card overflow-hidden shadow-sm">
                <div class="px-6 py-5 border-b border-gray-100 flex items-center justify-between bg-white sticky top-0 z-10">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">ğŸ‘¥</span>
                        <div class="flex flex-col">
                            <span class="font-bold text-lg text-gray-800 tracking-tight">ç¾¤èŠè§£ææƒé™ç®¡ç†</span>
                            <span id="total-groups" class="text-xs text-gray-400 font-normal">å…±è®¡æ‰«æåˆ° 0 ä¸ªç¾¤èŠ</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs">ğŸ”</span>
                            <input type="text" id="group-search" class="pl-9 pr-4 py-2.5 bg-gray-50 border border-gray-200 rounded-xl text-sm w-64 outline-none focus:bg-white focus:border-blue-400 focus:ring-2 focus:ring-blue-50 transition-all" placeholder="è¾“å…¥ç¾¤åæˆ–ç¾¤å·æœç´¢..." oninput="filterGroups()">
                        </div>
                        <div class="h-6 w-[1px] bg-gray-200 mx-1"></div>
                        <div class="flex gap-2">
                            <button class="px-3 py-1.5 text-xs text-blue-600 font-bold hover:bg-blue-50 rounded-lg transition" onclick="toggleAllGroups(true)">ä¸€é”®å…¨å¼€</button>
                            <button class="px-3 py-1.5 text-xs text-gray-400 font-bold hover:bg-gray-100 rounded-lg transition" onclick="toggleAllGroups(false)">ä¸€é”®å…¨å…³</button>
                        </div>
                    </div>
                </div>

                <div class="scroll-area bg-gray-50/30" id="groups-scroll">
                    <!-- åŠ è½½ä¸­ -->
                    <div id="groups-loading" class="py-32 text-center">
                        <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <div class="mt-4 text-sm text-gray-400 font-medium">æ­£åœ¨æ‹‰å–ç¾¤ç»„åˆ—è¡¨...</div>
                    </div>

                    <!-- åˆ—è¡¨å®¹å™¨ -->
                    <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3 hidden">
                        <!-- åŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <!-- ç©ºçŠ¶æ€ -->
                    <div id="groups-empty" class="py-32 text-center hidden">
                        <div class="text-5xl mb-4 grayscale">ğŸƒ</div>
                        <div class="text-base font-bold text-gray-400">æœªæ‰¾åˆ°åŒ¹é…çš„ç¾¤èŠ</div>
                        <p class="text-sm text-gray-300 mt-1">è¯·å°è¯•æ›´æ¢æœç´¢å…³é”®è¯</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const ROUTE_PREFIX = '/bilibili';
        const token = new URLSearchParams(window.location.search).get('webui_token') || '';
        let groupsData = [];
        let globalEnabled = true;
        let qrcodeKey = null;
        let pollTimer = null;
        let countdownTimer = null;
        let remainingTime = 180;
        
        // è¿è¡Œæ—¶é•¿ç›¸å…³å˜é‡
        let serverUptimeMs = 0;
        let uptimeTimerId = null;
        let lastFetchTime = 0;

        function authHeaders(h = {}) { if (token) h['Authorization'] = 'Bearer ' + token; return h; }
        
        // æ ¼å¼åŒ–è¿è¡Œæ—¶é•¿
        function formatUptime(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) {
                const h = hours % 24;
                const m = minutes % 60;
                return `${days}å¤©${h}æ—¶${m}åˆ†`;
            } else if (hours > 0) {
                const m = minutes % 60;
                const s = seconds % 60;
                return `${hours}æ—¶${m}åˆ†${s}ç§’`;
            } else if (minutes > 0) {
                const s = seconds % 60;
                return `${minutes}åˆ†${s}ç§’`;
            } else {
                return `${seconds}ç§’`;
            }
        }
        
        // æ›´æ–°è¿è¡Œæ—¶é•¿æ˜¾ç¤º
        function updateUptimeDisplay() {
            const uptimeEl = document.getElementById('uptime');
            if (serverUptimeMs > 0) {
                const elapsed = Date.now() - lastFetchTime;
                const currentUptime = serverUptimeMs + elapsed;
                uptimeEl.textContent = formatUptime(currentUptime);
            }
        }
        
        // å¯åŠ¨è¿è¡Œæ—¶é•¿å®šæ—¶å™¨
        function startUptimeTimer() {
            if (uptimeTimerId) clearInterval(uptimeTimerId);
            uptimeTimerId = setInterval(updateUptimeDisplay, 1000);
        }

        async function resolveApiBase() {
            const tries = [];
            if (window.__PLUGIN_NAME__) tries.push(window.__PLUGIN_NAME__);
            try {
                if (window.parent && window.parent.__PLUGIN_NAME__) tries.push(window.parent.__PLUGIN_NAME__);
            } catch (e) { }
            
            const extMatch = location.pathname.match(/\/ext\/([^\/]+)/);
            if (extMatch) tries.unshift(extMatch[1]);
            
            // é»˜è®¤å…œåº•
            tries.push('napcat-plugin-bilibili');
            
            for (const name of [...new Set(tries.filter(Boolean))]) {
                const base = '/api/Plugin/ext/' + name;
                try {
                    const r = await fetch(base + ROUTE_PREFIX + '/status', { headers: authHeaders() });
                    if (r.ok) return base;
                } catch (e) {}
            }
            return '/api/Plugin/ext/' + (window.__PLUGIN_NAME__ || 'napcat-plugin-bilibili');
        }

        let API_BASE_P = resolveApiBase();

        async function authFetch(path, options = {}) {
            const base = await API_BASE_P;
            const res = await fetch(base + ROUTE_PREFIX + path, {
                ...options,
                headers: { 'Content-Type': 'application/json', ...options.headers, ...authHeaders() }
            });
            if (!res.ok) {
                const text = await res.text();
                throw new Error(text || `HTTP ${res.status}`);
            }
            return res.json();
        }

        function showToast(msg, type = 'info') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            let bgClass = 'bg-blue-500';
            if (type === 'success') bgClass = 'bg-green-500';
            if (type === 'error') bgClass = 'bg-red-500';
            t.className = `toast ${bgClass}`;
            t.textContent = msg;
            c.appendChild(t);
            setTimeout(() => {
                t.style.transform = 'translateX(120%)';
                t.style.opacity = '0';
                setTimeout(() => t.remove(), 300);
            }, 3000);
        }

        async function loadStatus() {
            try {
                const res = await authFetch('/status');
                if (res.code === 0) {
                    const { config, uptime, uptimeFormatted, stats } = res.data;
                    globalEnabled = config.enabled !== false;
                    
                    const badge = document.getElementById('status-badge');
                    badge.className = `ml-2 px-3 py-1 rounded-full text-xs font-bold border ${globalEnabled ? 'bg-green-50 text-green-600 border-green-200' : 'bg-red-50 text-red-600 border-red-200'}`;
                    badge.textContent = globalEnabled ? 'è¿è¡Œä¸­' : 'å·²æš‚åœ';
                    
                    // ä½¿ç”¨æ¯«ç§’æ•°å®æ—¶æ›´æ–°è¿è¡Œæ—¶é•¿
                    if (typeof uptime === 'number' && uptime > 0) {
                        serverUptimeMs = uptime;
                        lastFetchTime = Date.now();
                        updateUptimeDisplay();
                        startUptimeTimer();
                    } else {
                        document.getElementById('uptime').textContent = uptimeFormatted || '--';
                    }
                    
                    document.getElementById('global-toggle').checked = globalEnabled;
                    document.getElementById('send-mode').value = config.sendMode || 'info-only';
                    document.getElementById('max-video-size').value = config.maxVideoSizeMB || 100;
                    
                    if (stats) {
                        document.getElementById('stats-today').textContent = stats.todayParsed || 0;
                        document.getElementById('stats-total').textContent = stats.totalParsed || 0;
                    }
                }
            } catch (e) {}
        }

        async function loadGroups() {
            try {
                const res = await authFetch('/groups');
                if (res.code === 0) {
                    groupsData = res.data || [];
                    document.getElementById('total-groups').textContent = `å…±è®¡æ‰«æåˆ° ${groupsData.length} ä¸ªç¾¤èŠ`;
                    document.getElementById('enabled-groups').textContent = groupsData.filter(g => g.biliEnabled !== false).length;
                    renderGroups();
                }
            } catch (e) {
                document.getElementById('groups-loading').innerHTML = '<div class="text-sm text-red-400 font-bold">æ‹‰å–åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</div>';
            }
        }

        function renderGroups(filter = '') {
            const container = document.getElementById('groups-container');
            const loading = document.getElementById('groups-loading');
            const empty = document.getElementById('groups-empty');
            loading.classList.add('hidden');

            const filtered = filter ? groupsData.filter(g => (g.group_name || '').toLowerCase().includes(filter.toLowerCase()) || String(g.group_id).includes(filter)) : groupsData;

            if (filtered.length === 0) {
                empty.classList.remove('hidden'); container.classList.add('hidden'); return;
            }

            empty.classList.add('hidden'); container.classList.remove('hidden');
            container.innerHTML = filtered.map(g => {
                const avatarUrl = `http://p.qlogo.cn/gh/${g.group_id}/${g.group_id}/100/`;
                return `
                <div class="group-item shadow-sm">
                    <div class="w-10 h-10 rounded-lg bg-blue-50 flex items-center justify-center text-sm font-bold text-blue-400 mr-4 flex-shrink-0 border border-blue-100 overflow-hidden">
                        <img src="${avatarUrl}" alt="" class="w-full h-full object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='${(g.group_name || 'G')[0]}';">
                    </div>
                    <div class="min-w-0 flex-1 mr-3">
                        <div class="text-sm font-bold text-gray-700 truncate mb-0.5">${g.group_name || 'æœªçŸ¥ç¾¤å'}</div>
                        <div class="text-[10px] text-gray-400 font-mono tracking-wider">${g.group_id}</div>
                    </div>
                    <label class="toggle-switch flex-shrink-0">
                        <input type="checkbox" ${g.biliEnabled !== false ? 'checked' : ''} ${!globalEnabled ? 'disabled' : ''} onchange="toggleGroup('${g.group_id}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            `}).join('');
        }

        function filterGroups() { renderGroups(document.getElementById('group-search').value.trim()); }

        async function toggleGlobal(enabled) {
            try {
                const res = await authFetch('/config', { method: 'POST', body: JSON.stringify({ enabled }) });
                if (res.code === 0) {
                    globalEnabled = enabled;
                    loadStatus(); renderGroups();
                    showToast(enabled ? 'è§£æåŠŸèƒ½å·²å¼€å¯' : 'è§£æåŠŸèƒ½å·²æš‚åœ', 'success');
                }
            } catch (e) { document.getElementById('global-toggle').checked = !enabled; }
        }

        async function updateConfig() {
            const sendMode = document.getElementById('send-mode').value;
            const maxVideoSizeMB = parseInt(document.getElementById('max-video-size').value) || 100;
            try {
                const res = await authFetch('/config', { method: 'POST', body: JSON.stringify({ sendMode, maxVideoSizeMB }) });
                if (res.code === 0) showToast('è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
            } catch (e) {}
        }

        async function toggleGroup(groupId, enabled) {
            try {
                const res = await authFetch(`/groups/${groupId}/config`, { method: 'POST', body: JSON.stringify({ enabled }) });
                if (res.code === 0) {
                    const g = groupsData.find(x => String(x.group_id) === String(groupId));
                    if (g) g.biliEnabled = enabled;
                    document.getElementById('enabled-groups').textContent = groupsData.filter(x => x.biliEnabled !== false).length;
                }
            } catch (e) { 
                console.error('Toggle group failed:', e);
                showToast('æ›´æ–°å¤±è´¥', 'error');
                loadGroups(); 
            }
        }

        async function toggleAllGroups(enabled) {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç¾¤æ•°æ®
            if (!groupsData || groupsData.length === 0) {
                showToast('ç¾¤åˆ—è¡¨ä¸ºç©ºï¼Œè¯·å…ˆåˆ·æ–°æ•°æ®', 'error');
                return;
            }
            
            try {
                const groupIds = groupsData.map(g => g.group_id);
                showToast(`æ­£åœ¨æ‰¹é‡${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'} ${groupIds.length} ä¸ªç¾¤...`, 'info');
                
                const res = await authFetch('/groups/bulk-config', {
                    method: 'POST',
                    body: JSON.stringify({ enabled, groupIds })
                });
                
                if (res.code === 0) {
                    groupsData.forEach(g => g.biliEnabled = enabled);
                    document.getElementById('enabled-groups').textContent = groupsData.filter(x => x.biliEnabled !== false).length;
                    renderGroups(document.getElementById('group-search').value.trim());
                    showToast(`å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}æ‰€æœ‰ç¾¤èŠ`, 'success');
                } else {
                    showToast('æ“ä½œå¤±è´¥: ' + (res.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (e) {
                console.error('Bulk update failed:', e);
                showToast('æ‰¹é‡æ“ä½œå¼‚å¸¸: ' + (e.message || 'ç½‘ç»œé”™è¯¯'), 'error');
            }
        }

        async function refreshAll() {
            showToast('æ­£åœ¨åˆ·æ–°...', 'info');
            await Promise.all([
                loadStatus(),
                loadGroups(),
                checkLoginStatus()
            ]);
            showToast('åˆ·æ–°å®Œæˆ', 'success');
        }

        async function checkLoginStatus() {
            try {
                const res = await authFetch('/login/status');
                document.getElementById('login-loading').classList.add('hidden');
                if (res.code === 0 && res.data?.isLoggedIn) showLoggedInUI(res.data.userInfo);
                else showLoginUI();
            } catch (e) { document.getElementById('login-loading').classList.add('hidden'); showLoginUI(); }
        }

        function showLoginUI() {
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('logged-in-section').classList.add('hidden');
        }

        function showLoggedInUI(u) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('logged-in-section').classList.remove('hidden');
            document.getElementById('user-avatar').src = u.face || '';
            document.getElementById('user-name').textContent = u.uname || 'æœªçŸ¥ç”¨æˆ·';
            document.getElementById('user-uid').textContent = 'UID: ' + (u.mid || '--');
            document.getElementById('user-level').textContent = u.level_info?.current_level || 0;
            document.getElementById('user-exp-current').textContent = u.level_info?.current_exp || 0;
            const next = u.level_info?.next_exp;
            document.getElementById('user-exp-next').textContent = typeof next === 'number' ? next : 'MAX';
            document.getElementById('user-level-progress').style.width = (typeof next === 'number' ? (u.level_info.current_exp / next * 100) : 100) + '%';
            document.getElementById('user-money').textContent = u.money ?? '--';
            document.getElementById('user-follower').textContent = u.relation_stat?.follower >= 10000 ? (u.relation_stat.follower/10000).toFixed(1)+'ä¸‡' : (u.relation_stat?.follower ?? '--');
            document.getElementById('user-moral').textContent = u.moral ?? '--';
            if (u.vip?.status === 1) document.getElementById('user-vip').classList.remove('hidden');
        }

        async function generateQrCode() {
            stopPolling();
            document.getElementById('qrcode-placeholder').classList.add('hidden');
            document.getElementById('qrcode-wrapper').classList.remove('hidden');
            document.getElementById('qrcode-status').textContent = 'äºŒç»´ç ç”Ÿæˆä¸­...';
            try {
                const res = await authFetch('/login/qrcode/generate', { method: 'POST' });
                if (res.code === 0) {
                    qrcodeKey = res.data.qrcode_key;
                    document.getElementById('qrcode-img').src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(res.data.url);
                    document.getElementById('qrcode-status').textContent = 'è¯·æ‰«ç ç™»å½•';
                    remainingTime = 180; startCountdown(); startPolling();
                }
            } catch (e) {}
        }

        function startCountdown() {
            if (countdownTimer) clearInterval(countdownTimer);
            countdownTimer = setInterval(() => { if (--remainingTime <= 0) stopPolling(); }, 1000);
        }

        function startPolling() {
            if (pollTimer) clearInterval(pollTimer);
            pollTimer = setInterval(async () => {
                try {
                    const res = await authFetch('/login/qrcode/poll?qrcode_key=' + encodeURIComponent(qrcodeKey));
                    if (res.code === 0 && res.data?.isSuccess) {
                        stopPolling(); showToast('ç™»å½•æˆåŠŸ', 'success'); checkLoginStatus();
                    }
                } catch (e) {}
            }, 2000);
        }

        function stopPolling() { clearInterval(pollTimer); clearInterval(countdownTimer); }
        function stopUptimeTimer() { if (uptimeTimerId) { clearInterval(uptimeTimerId); uptimeTimerId = null; } }

        // é€€å‡ºç™»å½•çŠ¶æ€ï¼š0-åˆå§‹ï¼Œ1-å¾…ç¡®è®¤ï¼Œ2-æ‰§è¡Œä¸­
        let logoutState = 0;
        async function logout() {
            if (logoutState === 0) {
                logoutState = 1;
                showToast('å†æ¬¡ç‚¹å‡»ç¡®è®¤é€€å‡ºç™»å½•', 'info');
                setTimeout(() => { logoutState = 0; }, 3000); // 3ç§’åé‡ç½®
                return;
            }
            if (logoutState === 2) return; // é˜²æ­¢é‡å¤ç‚¹å‡»
            logoutState = 2;
            
            try {
                const res = await authFetch('/login/logout', { method: 'POST' });
                if (res.code === 0) { showLoginUI(); showToast('è´¦å·å·²é€€å‡º', 'success'); }
            } catch (e) {
                showToast('é€€å‡ºå¤±è´¥', 'error');
            } finally {
                logoutState = 0;
            }
        }

        document.addEventListener('DOMContentLoaded', () => { loadStatus(); loadGroups(); checkLoginStatus(); setInterval(loadStatus, 60000); });
        window.addEventListener('beforeunload', () => { stopPolling(); stopUptimeTimer(); });
    </script>
</body>

</html>
